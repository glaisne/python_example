pipeline {

    agent { 
        node { 
            label 'linux'
        }
    }
    environment {
        TEST_SUBSCRIPTION_ID     = credentials('Test_Subscription_ID')
        AZURE_TENANT_ID     = credentials('Azure_Tenant_ID')
    }
    stages {
        stage ("setup") {
            steps {
                echo 'Install requirements...'
                sh("pip3 install -r requirements.txt")
            }
        }
        stage ("Information") {
            steps {
                echo 'Designing a python/Jenkins example setup'

                echo 'Python information'
                sh("pip3 list")
                sh("python3 -V")
            }
        }
        stage ("linting") {
            steps {
                sh("python3 -m pylint --rcfile ./pylint.config --reports y az")
            }
        }
        stage ("python unit tests") {
            steps {
                sh("python3 -m pytest ./tests/python_unit_tests/ -vv")
            }
        }
        stage ("Azure Auth") {
            steps {
                echo 'Connecting to Azure and setting the proper subscription'
                // login Azure
                withCredentials([usernamePassword(credentialsId: 'TestingGlaisne', passwordVariable: 'AZURE_CLIENT_SECRET', usernameVariable: 'AZURE_CLIENT_ID')]) {
                sh '''
                    az login \
                        --service-principal \
                        -u $AZURE_CLIENT_ID \
                        -p $AZURE_CLIENT_SECRET \
                        -t ${AZURE_TENANT_ID} \
                        --query "[?isDefault].{name: name, isDefault: isDefault, state: state, TenantId: homeTenantId, id: id}"
                    az account set \
                        -s ${TEST_SUBSCRIPTION_ID}
                    az account list \
                        --query "[?isDefault].{name: name, isDefault: isDefault, state: state, TenantId: homeTenantId, id: id}"
                '''
                }
            }
        }
        stage ("Azure_Deploy_Infrastructre") {
            steps {
                sh("python3 ./deploy.py")
            }
        }
        stage ("Infrastructure tests") {
            steps {
                //sh("cp ./config_testing.py ./tests/config_testing.py")
                sh("python3 ./infrastructre_tests/test_storage_account.py")
                sh("python3 ./infrastructre_tests/test_resource_group.py")
                sh("python3 ./infrastructre_tests/test_container_registry.py")
                sh("python3 ./infrastructre_tests/test_aks.py")
                sh("python3 ./infrastructre_tests/test_nsg.py")
            }
        }

    }
}
